# Supercheck Docker Swarm Deployment

This directory contains all the necessary files and documentation for deploying Supercheck on a Docker Swarm cluster running on Hetzner servers.

## Directory Structure

```
docker/
├── README.md                           # This file
├── stacks/                             # Docker stack definitions
│   ├── supercheck.yml                  # Main application stack
│   └── monitoring.yml                  # Monitoring and logging stack
├── scripts/                            # Automation and utility scripts
│   ├── initial-setup.sh                # Server initialization script
│   ├── swarm-init.sh                   # Docker Swarm initialization
│   ├── setup-traefik.sh                # Traefik setup script
│   ├── health-check.sh                 # System health check
│   ├── backup-*.sh                     # Backup scripts
│   └── recover-*.sh                    # Recovery scripts
├── configs/                            # Configuration files
│   ├── .env.production.example         # Production environment template
│   ├── traefik/                        # Traefik configuration
│   ├── postgres/                       # PostgreSQL configuration
│   ├── redis/                          # Redis configuration
│   ├── prometheus/                     # Prometheus configuration
│   ├── grafana/                        # Grafana configuration
│   ├── alertmanager/                   # AlertManager configuration
│   └── loki/                           # Loki configuration
└── docs/                               # Documentation
    ├── HETZNER_DOCKER_SWARM_SETUP.md   # Main setup guide
    ├── NETWORKING_SECURITY_BEST_PRACTICES.md # Security guide
    ├── MONITORING_LOGGING_SETUP.md     # Monitoring setup guide
    ├── BACKUP_DISASTER_RECOVERY.md     # Backup and recovery guide
    └── TROUBLESHOOTING.md              # Troubleshooting guide
```

## Quick Start

### Prerequisites

- Hetzner Cloud account with API access
- At least 3 servers (2GB+ RAM, 20GB+ storage)
- SSH key pair configured
- Domain name (optional but recommended)

### 1. Server Setup

```bash
# Clone the repository
git clone <repository-url>
cd supercheck-core/docker

# Create Hetzner servers
./scripts/create-servers.sh

# Initialize servers
./scripts/initialize-all-servers.sh
```

### 2. Docker Swarm Setup

```bash
# Initialize Swarm on first manager
./scripts/swarm-init.sh init

# Join other managers
./scripts/swarm-init.sh join manager <manager-ip> <token>

# Join workers
./scripts/swarm-init.sh join worker <manager-ip> <token>
```

### 3. Deploy Stacks

```bash
# Configure environment
cp configs/.env.production.example configs/.env.production
# Edit configs/.env.production with your values

# Deploy application
docker stack deploy -c stacks/supercheck.yml supercheck

# Deploy monitoring
docker stack deploy -c stacks/monitoring.yml monitoring
```

### 4. Verify Deployment

```bash
# Check service status
docker service ls
docker stack ps supercheck
docker stack ps monitoring

# Check health
./scripts/health-check.sh
```

## Configuration

### Environment Variables

Key environment variables to configure in `configs/.env.production`:

```bash
# Domain and SSL
DOMAIN=yourdomain.com
LETSENCRYPT_EMAIL=admin@yourdomain.com
TRAEFIK_BASIC_AUTH=admin:$apr1$hash  # Generate with htpasswd

# Database
POSTGRES_PASSWORD=your_secure_password
REDIS_PASSWORD=your_secure_password

# Storage
MINIO_ROOT_PASSWORD=your_secure_password
S3_BUCKET_NAME=supercheck-artifacts

# Authentication
NEXTAUTH_SECRET=your_nextauth_secret
NEXTAUTH_URL=https://yourdomain.com

# AI Features (optional)
AI_FIX_ENABLED=true
OPENAI_API_KEY=your_openai_api_key

# Email
SMTP_HOST=smtp.yourprovider.com
SMTP_USER=your_email
SMTP_PASSWORD=your_email_password
```

### SSL/TLS Configuration

Traefik automatically handles SSL certificates with Let's Encrypt:

```bash
# SSL certificates are automatically generated by Traefik
# Configure domain in configs/.env.production
DOMAIN=yourdomain.com
LETSENCRYPT_EMAIL=admin@yourdomain.com

# Set up Traefik
./scripts/setup-traefik.sh
```

## Monitoring

Access monitoring dashboards:

- **Traefik Dashboard**: http://traefik.yourdomain.com:8080
- **Grafana**: https://grafana.yourdomain.com
- **Prometheus**: https://monitoring.yourdomain.com
- **AlertManager**: https://alerts.yourdomain.com

## Backup and Recovery

### Automated Backups

Backups are automatically configured via cron:

```bash
# View backup schedule
crontab -l

# Manual backup
./scripts/backup-orchestrator.sh

# Restore from backup
./scripts/recover-system.sh YYYYMMDD
```

### Backup Locations

- **Local**: `/opt/docker/backups/`
- **Cloud**: S3 bucket (configured in environment)

## Security

### Network Security

- Private networks for inter-service communication
- Firewall rules configured automatically
- SSL/TLS encryption for all external traffic (handled by Traefik)
- Automatic HTTP to HTTPS redirection
- Security headers and rate limiting

### Access Control

- SSH key authentication only
- Role-based access control (RBAC)
- Docker secrets for sensitive data

### Security Hardening

```bash
# Run security hardening
./scripts/security-hardening.sh

# Security audit
./scripts/security-audit.sh
```

## Maintenance

### Regular Tasks

```bash
# System health check
./scripts/health-check.sh

# Clean up resources
docker system prune -f

# Update services
./scripts/update-services.sh

# Backup verification
./scripts/verify-backups.sh
```

### Log Rotation

Logs are automatically rotated, but you can manually rotate:

```bash
./scripts/rotate-logs.sh
```

## Troubleshooting

### Common Issues

1. **Services not starting**

   ```bash
   docker service logs <service-name>
   docker service ps <service-name>
   ```

2. **Network connectivity**

   ```bash
   docker network ls
   docker network inspect <network-name>
   ```

3. **High resource usage**
   ```bash
   docker stats
   ./scripts/performance-check.sh
   ```

### Debug Tools

```bash
# Container debug
./scripts/debug-container.sh <container-name>

# Service debug
./scripts/debug-service.sh <service-name>

# Network debug
./scripts/debug-network.sh <network-name>
```

## Scaling

### Horizontal Scaling

```bash
# Scale application services
docker service scale supercheck_app=3
docker service scale supercheck_worker=5

# Scale monitoring
docker service scale monitoring_prometheus=2
```

### Vertical Scaling

```bash
# Update resource limits
docker service update --limit-memory 4G supercheck_app
docker service update --limit-cpu 2.0 supercheck_worker
```

## Performance Optimization

### Database Optimization

```bash
# Optimize PostgreSQL
./scripts/optimize-postgres.sh

# Check query performance
docker exec postgres psql -U postgres -d supercheck -c "
SELECT query, calls, total_time FROM pg_stat_statements
ORDER BY total_time DESC LIMIT 10;"
```

### Application Optimization

```bash
# Enable caching
docker service update --env-add CACHE_ENABLED=true supercheck_app

# Configure connection pooling
docker service update --env-add DB_POOL_MAX=20 supercheck_app
```

## Disaster Recovery

### Recovery Procedures

1. **Service Recovery**

   ```bash
   ./scripts/recover-service.sh <service-name>
   ```

2. **Full System Recovery**

   ```bash
   ./scripts/full-recovery.sh
   ```

3. **Data Recovery**
   ```bash
   ./scripts/recover-database.sh <backup-file>
   ./scripts/recover-minio.sh <backup-date>
   ```

### Testing Recovery

```bash
# Test backup recovery
./scripts/test-recovery.sh

# Disaster recovery drill
./scripts/disaster-recovery-drill.sh
```

## Compliance

### GDPR Compliance

```bash
# Generate GDPR-compliant backup
./scripts/gdpr-backup.sh

# Data anonymization
./scripts/anonymize-data.sh
```

### Audit Trail

```bash
# Generate audit report
./scripts/audit-report.sh

# View backup audit log
tail -f /var/log/backup-audit.log
```

## Support

### Getting Help

1. Check the documentation in `docs/`
2. Run the health check script
3. Review troubleshooting guide
4. Check logs for error messages

### Reporting Issues

When reporting issues, include:

- System information from `./scripts/health-check.sh`
- Relevant logs from `docker service logs`
- Configuration from `configs/.env.production`
- Steps to reproduce the issue

## Contributing

### Development Setup

```bash
# Set up development environment
./scripts/setup-dev.sh

# Run tests
./scripts/run-tests.sh

# Build and deploy
./scripts/build-and-deploy.sh
```

### Code Style

- Follow existing code patterns
- Use shellcheck for shell scripts
- Document all scripts and configurations
- Test all changes in development environment

## License

This deployment configuration is part of the Supercheck project. See the main project license for details.

## Version History

- **v1.0.0** - Initial Docker Swarm deployment
- **v1.1.0** - Added monitoring stack
- **v1.2.0** - Enhanced security features
- **v1.3.0** - Automated backup and recovery
- **v1.4.0** - Performance optimizations

## Changelog

### v1.4.0 (Current)

- Added comprehensive monitoring with Prometheus/Grafana
- Implemented automated backup and recovery
- Enhanced security hardening
- Added performance optimization tools
- Improved troubleshooting documentation

### Upcoming Features

- Multi-region deployment support
- Advanced auto-scaling
- Enhanced AI-powered monitoring
- Integrated CI/CD pipeline
- Cost optimization tools
