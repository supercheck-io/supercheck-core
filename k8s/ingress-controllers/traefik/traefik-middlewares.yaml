# Security Headers Middleware for Supercheck
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: supercheck-headers
  namespace: supercheck
spec:
  headers:
    customRequestHeaders:
      X-Forwarded-Proto: "https"
    customResponseHeaders:
      X-Frame-Options: "DENY"
      X-Content-Type-Options: "nosniff"
      X-XSS-Protection: "1; mode=block"
      Strict-Transport-Security: "max-age=31536000; includeSubDomains"
      Content-Security-Policy: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' wss: ws:;"
---
# Upload Size Middleware for large test artifacts
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: supercheck-upload-size
  namespace: supercheck
spec:
  buffering:
    maxRequestBodyBytes: 104857600  # 100MB for test artifacts
    memRequestBodyBytes: 10485760   # 10MB in memory buffer
    maxResponseBodyBytes: 104857600  # 100MB response
    memResponseBodyBytes: 10485760   # 10MB response buffer
---
# Rate Limiting for API endpoints
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: supercheck-ratelimit
  namespace: supercheck
spec:
  rateLimit:
    burst: 100
    average: 50
    period: 1m
    sourceCriterion:
      ipStrategy:
        depth: 1
---
# MinIO Authentication Middleware
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: minio-auth
  namespace: supercheck
spec:
  basicAuth:
    secret: minio-auth-secret
---
# MinIO Upload Size Middleware
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: minio-upload
  namespace: supercheck
spec:
  buffering:
    maxRequestBodyBytes: 1073741824   # 1GB for large test artifacts
    memRequestBodyBytes: 104857600    # 100MB in memory
    maxResponseBodyBytes: 1073741824  # 1GB response
    memResponseBodyBytes: 104857600   # 100MB response buffer
---
# Compression Middleware for better performance
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: supercheck-compress
  namespace: supercheck
spec:
  compress:
    excludedContentTypes:
    - text/event-stream  # Don't compress SSE streams
---
# Circuit Breaker for worker services
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: worker-circuit-breaker
  namespace: supercheck
spec:
  circuitBreaker:
    expression: "NetworkErrorRatio() > 0.3 || ResponseCodeRatio(500, 600, 0, 600) > 0.3"
    checkPeriod: 10s
    fallbackDuration: 30s
    recoveryDuration: 30s
---
# Redirect HTTP to HTTPS
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: https-redirect
  namespace: supercheck
spec:
  redirectScheme:
    scheme: https
    permanent: true
---
# CORS Middleware for API access
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: supercheck-cors
  namespace: supercheck
spec:
  headers:
    accessControlAllowMethods:
    - "GET"
    - "POST"
    - "PUT"
    - "DELETE"
    - "OPTIONS"
    accessControlAllowOriginList:
    - "https://supercheck.yourdomain.com"
    accessControlAllowHeaders:
    - "Content-Type"
    - "Authorization"
    - "X-Requested-With"
    accessControlExposeHeaders:
    - "X-Total-Count"
    - "X-Pagination-Count"
    accessControlAllowCredentials: true
    accessControlMaxAge: 86400